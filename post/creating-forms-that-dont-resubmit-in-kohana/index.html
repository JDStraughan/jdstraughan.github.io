<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Creating forms that don't resubmit in Kohana | Jason Straughan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jason Straughan is a web developer living in San Antonio, Texas that specializes in Ruby, Rails, and all things web.">
    <meta name="author" content="Jason D. Straughan (JDStraughan)">
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono|Droid+Serif:700' rel='stylesheet' type='text/css'>
    <link href='/assets/global-3ba92bb3a000ff43c55f945193de7b7e.css' rel='stylesheet' type='text/css' />

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
            <a class="brand" href="/">JDStraughan.com</a>
            <div class="nav-collapse collapse">
              <ul class="nav pull-right">
                
                  
                    
                      <li class="active">
                    
                  
                
                  <a href="/">blog</a></li>  
                
                
                
  
    
      <li><a href="/about.html">about</a></li>
    
  

  

  

  
    
      <li><a href="/portfolio.html">portfolio</a></li>
    
  

  

  

  

  

  



              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </div>
      </div>

    <div class="container-fluid">
      <div class="row-fluid">
        
        <div class="span9">
          <section class="main-content">
            <h1 class="post">Creating forms that don't resubmit in Kohana</h1>
<p class="date_published">30 Mar 2011</p>
<div id="post">
	<p>It is&nbsp;definitely&nbsp;one of my pet peeves: reloading a page only to see the "Confirm Form Resubmission" alert box that wants me to find my mouse and click on something that could have easily been prevented by the developer. &nbsp;This is 2011, for crying out loud, can't we have forms that don't suck?</p>

<p>The easiest solution to this problem is to load all posted form data into the session, and then reload the page internally. &nbsp;This clears the POST request while maintaining the submission and makes for happier users (and less headaches about the same comment submitted 14 times in a row).</p>

<p>Using Kohana's Session class makes it even simpler to remedy this ill of the internet. &nbsp;It really does not matter which driver you use, simply create a session and drop in the submission. &nbsp;The following controller action demonstrates the basics of this feature:</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span> <span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;SYSPATH&#39;</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;No direct script access.&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">Controller_Form</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

	<span class="k">public</span> <span class="k">function</span> <span class="nf">action_test</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nv">$session</span> <span class="o">=</span> <span class="nx">Session</span><span class="o">::</span><span class="na">instance</span><span class="p">();</span>
		
		<span class="nv">$example</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Model_Example</span><span class="p">;</span>
		
		<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">template</span><span class="o">-&gt;</span><span class="na">content</span> <span class="o">=</span> <span class="nx">View</span><span class="o">::</span><span class="na">factory</span><span class="p">(</span><span class="s1">&#39;form/test&#39;</span><span class="p">)</span>
			<span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">)</span>
			<span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="nv">$errors</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span>
		<span class="p">{</span>
			
			<span class="nv">$post</span> <span class="o">=</span> <span class="nv">$example</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">check</span><span class="p">())</span>
			<span class="p">{</span>
				<span class="c1">// Process Form</span>
				<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
				<span class="nx">Request</span><span class="o">::</span><span class="na">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nx">url</span><span class="o">::</span><span class="na">site</span><span class="p">(</span><span class="s1">&#39;somewhere&#39;</span><span class="p">));</span>
			<span class="p">}</span> 
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">());</span>
				<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">);</span>
				<span class="nx">Request</span><span class="o">::</span><span class="na">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nx">url</span><span class="o">::</span><span class="na">site</span><span class="p">(</span><span class="s1">&#39;back-here&#39;</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> 
		<span class="k">elseif</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">))</span> 
		<span class="p">{</span>
			<span class="nv">$_POST</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">);</span>
			<span class="nv">$errors</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">);</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">);</span>
			<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now a simple view script with a form is all that is needed to complete this exercise.  Although this is really just pseudo-code, I hope you get the idea.</p>

<p>To see this in action, fill out the comment section below, but leave the email input blank. &nbsp;The form will have errors, the messages will be displayed, the from will remain sticky (you other data will persist), but a refresh of the page will not show any resubmission warnings. &nbsp;Hopefully, this makes you a happier user.  If not, let me know by commenting below, and feel free to ask any questions.</p></div>
<div id="comments" class="clearfix">
		
	<div id="comment_header">
		<h3>Comments (2) <br> These comments are frozen, as they are archived from my previous blog.</h3>
	</div>
		
				<div class="comment clearfix ">
			<p class="span2">
								<img src="http://www.gravatar.com/avatar/d792df8d71cdd919daf59ef2fec048bf" alt="gravatar" />
				<br /> 
				 
					<a href="http://kloopko.com">kemo</a>								<br /> 
				<span class="date_created">
					about a year ago				</span>
			</p>
			<p class="span10 pull-right">
				I like the way of writting but there's a catch with the session key you're using: you should point users to use the actual form's name for it so that they can still normally use other forms after validation in this one fails (example).			</p>
			
		</div>
				<div class="comment clearfix author-comment">
			<p class="span2">
								<img src="http://www.gravatar.com/avatar/159950296dc98fc2efde54faa38e04f8" alt="gravatar" />
				<br /> 
				 
					<a href="http://jdstraughan.com">JDStraughan</a>								<br /> 
				<span class="date_created">
					about a year ago				</span>
			</p>
			<p class="span10 pull-right">
				@kemo: That is a very good point.  I named the session 'post' key as it is really just psuedo-code, and wanted people to understand the concept.  I agree that in a real world scenario the session keys should be unique to the form being used.			</p>
			
		</div>
          </section>
        </div><!--/span-->
        
        <div class="span3">

          <img src="/img/jason-straughan.png" width="183" height="275" alt="Jason Straughan" class="mypic">
          <h5 class="myname">Jason Straughan</h5>
          <p class="mybio">I live in the beautiful Texas hill country where I concentrate on building great web applications, writing, and enjoying time with my family. Recently I completed my first book, "Beginning Kohana 3 Development" for Packt Publishing.</p>
          
          <hr>
          
          <h3>Recent Posts</h3>
          <ul class="naked">
          
           <li><a href="/2013/02/07/nonews-part-2-the-source">NoNews Part II - The Source</a></li>
          
           <li><a href="/2013/01/29/nonews-is-good-news">NoNews (is Good News!)</a></li>
          
           <li><a href="/2013/01/28/jekyll-is-just-what-the-dr-ordered">Jekyll is just what the doctor ordered</a></li>
          
          </ul>
          
          <hr>
          
          <h3>Posts by Tag</h3>
          <div id="tag-cloud">
            <a href="/tag/chrome%20extension.html" class="set-5">chrome extension</a> <a href="/tag/javascript.html" class="set-5">javascript</a> <a href="/tag/jekyll.html" class="set-1">jekyll</a>
          </div>
          
        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <p>&copy; 2012 Jason D. Straughan | JDStraughan.com</p>
        <p>Hosted for free on <a href="http://pages.github.com/">GitHub Pages</a></p>
      </footer>

    </div><!--/.fluid-container-->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src='/assets/global-fce6899f5de9a0d1de2f5dafb8af0928.js' type='text/javascript'></script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
    <script type="text/javascript">try{ clicky.init(66405120); }catch(e){}</script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66405120ns.gif" /></p></noscript>
  </body>
</html>
